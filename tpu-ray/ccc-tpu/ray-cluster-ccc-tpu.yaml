apiVersion: ray.io/v1
kind: RayCluster
metadata:
  name: pytorch-mnist-cluster

spec:
  suspend: false #true ensures all pods start together
  rayVersion: '2.47.0'
  headGroupSpec:
    rayStartParams:
      dashboard-host: '0.0.0.0'
    template:
      spec:
        nodeSelector:
          cloud.google.com/gke-nodepool: "system"
        containers:
        - name: ray-head
          image: us-east1-docker.pkg.dev/gpu-launchpad-playground/gke-llm/ray-tpu-jax:latest #rayproject/ray-ml:2.9.0
          ports:
            - containerPort: 6379
              name: gcs-server
            - containerPort: 8265
              name: dashboard
            - containerPort: 10001
              name: client
          resources:
            limits:
              cpu: "1"
              memory: "2G"
              ephemeral-storage: "9Gi"
            requests:
              cpu: "1"
              memory: "2G"
              ephemeral-storage: "9Gi"
          volumeMounts:
            - mountPath: /tmp/ray
              name: ray-logs
        volumes:
          - name: ray-logs
            emptyDir: {}
  workerGroupSpecs:
  - replicas: 1
    minReplicas: 0
    maxReplicas: 1
    numOfHosts: 2
    groupName: tpu-group
    rayStartParams: {}
      #num-cpus: "220"
    template:
      metadata:
        annotations: {}
          #provreq.kueue.x-k8s.io/maxRunDurationSeconds: "41600" # Max run time in sec
          #kueue.x-k8s.io/podset-preferred-topology: "kubernetes.io/hostname"          
      spec:
        nodeSelector:
          #cloud.google.com/gke-nodepool: "v6e-2-4"
          cloud.google.com/compute-class: "ccc-tpu"
          cloud.google.com/gke-tpu-accelerator: tpu-v6e-slice
          cloud.google.com/gke-tpu-topology: 2x4
        hostNetwork: true
        dnsPolicy: ClusterFirstWithHostNet
        containers:
        - name: ray-worker
          image: us-east1-docker.pkg.dev/gpu-launchpad-playground/gke-llm/ray-tpu-jax:latest #rayproject/ray-ml:2.9.0 
          env:
           - name: ENABLE_PJRT_COMPATIBILITY
             value: "true"
           - name: HUGGING_FACE_HUB_TOKEN
             valueFrom:
                secretKeyRef:
                  name: hf-secret
                  key: hf_api_token
           - name: JAX_PLATFORMS
             value: "tpu"
           #- name: JAX_FORCE_TPU_INIT
           #  value: "true"
          #command:
          #- bash
          #- -c
          #- |
          #  pip install 'jax[tpu]' -f https://storage.googleapis.com/jax-releases/libtpu_releases.html
          resources:
            limits:
                cpu: "100"
                google.com/tpu: "4"
                ephemeral-storage: 40G
                memory: 200G
            requests:
                cpu: "100"
                google.com/tpu: "4"
                ephemeral-storage: 40G
                memory: 200G
          